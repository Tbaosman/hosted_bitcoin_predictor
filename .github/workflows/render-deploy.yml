name: Trigger Render Deployment

on:
  # Trigger when models are updated
  push:
    branches:
      - main
    paths:
      - 'models/saved_models/**'
      - 'wikipedia_edits.csv'
      - 'app.py'
      - 'requirements.txt'
      - 'Procfile'
  # Allow manual trigger
  workflow_dispatch:

jobs:
  notify-render:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Notify Render to deploy
        run: |
          echo "‚úÖ Code updated. Render will auto-deploy if webhook is configured."
          echo "üìù To manually trigger Render deployment:"
          echo "   1. Go to your Render dashboard"
          echo "   2. Click 'Manual Deploy' on your service"
          echo ""
          echo "üí° Tip: Configure Render webhook for automatic deployments:"
          echo "   Settings > Build & Deploy > Build Hook URL"
          
      - name: Generate and Commit JSON Data
        run: |
          # WARNING: This runs app.py. Ensure it generates the file and exits quickly, 
          # otherwise this step will time out.
          python app.py
          
          if [ -f "prediction_history.json" ]; then
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            
            git add prediction_history.json
            
            # Check if there are changes to commit (the new JSON file)
            if git diff --staged --quiet; then
                git commit -m "ü§ñ Auto-update: Generate dashboard_data.json [skip ci]" 
                # [skip ci] is crucial to prevent this commit from re-triggering this workflow!
                git pull --rebase origin main
                git push
            else
                echo "JSON file was generated but content did not change."
            fi
          else
            echo "‚ùå JSON file (prediction_history.json) was not created by app.py."
          fi

      # Optional: Trigger Render deployment via webhook if you have it configured
      # Uncomment and add your Render webhook URL as a GitHub secret
      # - name: Trigger Render webhook
      #   if: github.event_name == 'push'
      #   run: |
      #     curl -X POST "${{ secrets.RENDER_WEBHOOK_URL }}"

