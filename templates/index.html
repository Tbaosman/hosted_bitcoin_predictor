<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin AI Predictor</title>
    
    <!-- External Libraries - FIXED VERSION -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Our CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fab fa-bitcoin"></i> Bitcoin AI Predictor</h1>
            <p>AI-powered prediction for tomorrow's Bitcoin price movement using Wikipedia sentiment analysis</p>
            <div class="status-indicators">
                <div class="status-item">
                    <span class="status-dot live"></span>
                    Live Data
                </div>
                <div class="status-item">
                    <span class="status-dot model"></span>
                    Model Ready
                </div>
                <div class="status-item">
                    <span class="status-dot api"></span>
                    API Connected
                </div>
            </div>
        </div>
        
        <div class="content">
            <!-- Tabs Navigation -->
            <div class="tabs">
                <div class="tab active" onclick="switchTab('dashboard')">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </div>
                <div class="tab" onclick="switchTab('analytics')">
                    <i class="fas fa-chart-bar"></i> Analytics
                </div>
                <div class="tab" onclick="switchTab('history')">
                    <i class="fas fa-history"></i> Prediction History
                </div>
                <div class="tab" onclick="switchTab('training')">
                    <i class="fas fa-cogs"></i> Training
                </div>
            </div>
            
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <div class="dashboard-grid">
                    <!-- Prediction Section -->
                    <div class="prediction-section">
                        <h2 class="chart-title"><i class="fas fa-crystal-ball"></i> Live Prediction</h2>
                        
                        <div class="prediction-card" id="predictionCard">
                            <div class="prediction-text" id="predictionText">
                                <i class="fas fa-sync-alt"></i> Click "Get Prediction"
                            </div>
                            
                            <div class="confidence-meter">
                                <div class="confidence-fill" id="confidenceFill" style="width: 0%"></div>
                            </div>
                            
                            <div class="confidence-text">
                                <span id="confidenceText">Confidence Level</span>
                                <span id="confidenceValue">0%</span>
                            </div>
                            
                            <div class="price" id="priceText">
                                $--
                            </div>
                            <div id="priceChange" class="price-change"></div>
                            
                            <div id="predictionDate" style="margin-top: 10px; color: #6c757d;"></div>
                            
                            <!-- Probability Breakdown -->
                            <div class="probability-breakdown" style="margin-top: 15px; font-size: 0.9em;">
                                <span id="upProbability" class="prob-up">UP: 0%</span>
                                <span id="downProbability" class="prob-down">DOWN: 0%</span>
                            </div>
                        </div>

                        <!-- Prediction Explanation -->
                        <div class="prediction-explanation">
                            <h4><i class="fas fa-info-circle"></i> How to Interpret</h4>
                            <ul>
                                <li><strong>UP Prediction</strong>: Model expects price increase tomorrow</li>
                                <li><strong>DOWN Prediction</strong>: Model expects price decrease tomorrow</li>
                                <li><strong>Confidence</strong>: Model's certainty in prediction (70%+ is high)</li>
                                <li><strong>Current Price</strong>: Bitcoin price at prediction time</li>
                            </ul>
                        </div>

                        <!-- Confidence Guide -->
                        <div class="confidence-guide">
                            <h4><i class="fas fa-chart-line"></i> Confidence Levels</h4>
                            <div class="confidence-levels">
                                <div class="level-item">
                                    <span class="level-dot high"></span>
                                    <strong>High (70-100%)</strong>: Strong signal
                                </div>
                                <div class="level-item">
                                    <span class="level-dot medium"></span>
                                    <strong>Medium (50-70%)</strong>: Moderate confidence
                                </div>
                                <div class="level-item">
                                    <span class="level-dot low"></span>
                                    <strong>Low (0-50%)</strong>: Weak signal - use caution
                                </div>
                            </div>
                        </div>
                        
                        <div class="button-group">
                            <button class="button" onclick="getPrediction()" id="predictBtn">
                                <i class="fas fa-crystal-ball"></i> Get Prediction
                            </button>
                            <button class="button button-secondary" onclick="updateData()" id="updateBtn">
                                <i class="fas fa-sync-alt"></i> Update Data
                            </button>
                        </div>

                        <!-- Data Freshness Indicator -->
                        <div class="data-freshness" id="dataFreshness">
                            <span class="fresh">ðŸŸ¢ Data Updated Recently</span>
                        </div>
                    </div>
                    
                    <!-- Stats Section -->
                    <div class="prediction-section">
                        <h2 class="chart-title"><i class="fas fa-chart-pie"></i> Model Performance</h2>
                        
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-label">Precision</div>
                                <div class="stat-value" id="precisionStat">--%</div>
                                <div class="stat-label">Recent Predictions </div>
                            </div>
                            
                            <div class="stat-card up">
                                <div class="stat-label">Correct UP</div>
                                <div class="stat-value" id="upAccuracy">--%</div>
                                <div class="stat-label">Predictions</div>
                            </div>
                            
                            <div class="stat-card down">
                                <div class="stat-label">Correct DOWN</div>
                                <div class="stat-value" id="downAccuracy">--%</div>
                                <div class="stat-label">Predictions</div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="stat-label">Avg Confidence</div>
                                <div class="stat-value" id="avgConfidence">--%</div>
                                <div class="stat-label">All Predictions</div>
                            </div>
                        </div>

                        <!-- Performance Context -->
                        <div class="performance-context">
                            <p><small>
                                <i class="fas fa-lightbulb"></i> 
                                <strong>Industry Context</strong>:
                                <span id="performanceContext">
                                    Our model achieves <strong id="improvementOverRandom">+2.6%</strong> over random guessing (50%).                                                                               Financial prediction models are considered good at 55-65% accuracy. 
                                                We analyze <strong id="trainingDays">4,082</strong> days of historical data.
                                </span>
                            </small></p>
                        </div>
                        
                        <div class="chart-container">
                            <canvas id="performanceChart"></canvas>
                        </div>

                        <!-- Performance Details -->
                        <div class="performance-details">
                            <h4><i class="fas fa-chart-line"></i> Model Performance Analysis</h4>
                            <div class="performance-grid">
                                <div>
                                    <strong>Performance Grade:</strong> 
                                    <span id="performanceGrade" class="grade-c">C</span>
                                    <small id="performanceQuality">(Moderate)</small>
                                </div>
                                <div>
                                    <strong>Improvement vs Random:</strong> 
                                    <span id="improvementScore" class="positive">+2.6%</span>
                                </div>
                                <div>
                                    <strong>Model Type:</strong> 
                                    <span>XGBoost + Wikipedia Sentiment</span>
                                </div>
                                <div>
                                    <strong>Last Training:</strong> 
                                    <span id="lastTrainingDate">2025-11-20</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Price Chart -->
                <div class="chart-container">
                    <h2 class="chart-title"><i class="fab fa-bitcoin"></i> Bitcoin Price History</h2>
                    <canvas id="priceChart"></canvas>
                </div>
                
                <!-- Sentiment Chart -->
                <div class="chart-container sentiment-chart-container">
                    <h2 class="chart-title"><i class="fas fa-smile"></i> Wikipedia Sentiment Analysis</h2>
                    <canvas id="sentimentChart"></canvas>
                    
                    <!-- Sentiment Details - FIXED POSITIONING -->
                    <div class="sentiment-details">
                        <h4><i class="fas fa-info-circle"></i> Sentiment Insights</h4>
                        <div class="sentiment-grid">
                            <div>
                                <strong>Total Edits:</strong> 
                                <span id="totalEdits">0</span>
                            </div>
                            <div>
                                <strong>Avg Sentiment:</strong> 
                                <span id="avgSentiment">0.00</span>
                            </div>
                            <div>
                                <strong>Sentiment Trend:</strong> 
                                <span id="sentimentTrend">stable</span>
                            </div>
                            <div>
                                <strong>Data Points:</strong> 
                                <span id="sentimentDataPoints">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Analytics Tab -->
            <div id="analytics" class="tab-content">
                <div class="dashboard-grid">
                    <div class="chart-container">
                        <h2 class="chart-title"><i class="fas fa-project-diagram"></i> Feature Importance</h2>
                        <canvas id="featureChart"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <h2 class="chart-title"><i class="fas fa-brain"></i> Model Confidence Distribution</h2>
                        <canvas id="confidenceChart"></canvas>
                    </div>
                </div>

                <!-- Feature Explanations -->
                <div class="feature-explanations">
                    <h3><i class="fas fa-cogs"></i> Feature Descriptions</h3>
                    <div class="feature-grid">
                        <div class="feature-item">
                            <strong>Close Ratios</strong>: Price compared to moving averages
                        </div>
                        <div class="feature-item">
                            <strong>Trend Indicators</strong>: Recent price direction momentum
                        </div>
                        <div class="feature-item">
                            <strong>Edit Counts</strong>: Wikipedia activity volume
                        </div>
                        <div class="feature-item">
                            <strong>Sentiment Scores</strong>: Emotional tone of Wikipedia edits
                        </div>
                    </div>
                    
                    <!-- Feature Categories -->
                    <div class="feature-categories">
                        <div class="category-item">
                            <strong>Price Trends:</strong> <span id="categoryPrice">0 features</span>
                        </div>
                        <div class="category-item">
                            <strong>Sentiment Analysis:</strong> <span id="categorySentiment">0 features</span>
                        </div>
                        <div class="category-item">
                            <strong>Wikipedia Activity:</strong> <span id="categoryWikipedia">0 features</span>
                        </div>
                        <div class="category-item">
                            <strong>Technical Indicators:</strong> <span id="categoryTechnical">0 features</span>
                        </div>
                    </div>
                    
                    <!-- Top Feature -->
                    <div class="top-feature">
                        <strong id="topFeature">Top Feature: Loading...</strong>
                    </div>
                </div>
                
                <div class="info-grid">
                    <div class="info-item">
                        <h3><i class="fas fa-lightbulb"></i> How It Works</h3>
                        <p>Our AI analyzes Wikipedia Bitcoin page edits for sentiment patterns and combines them with technical indicators to predict price movements.</p>
                        <ul>
                            <li>Real-time Wikipedia edit analysis</li>
                            <li>15+ technical indicators</li>
                            <li>XGBoost machine learning model</li>
                            <li>Daily model retraining</li>
                        </ul>
                    </div>
                    
                    <div class="info-item">
                        <h3><i class="fas fa-rocket"></i> Model Details</h3>
                        <p><strong>Algorithm:</strong> XGBoost Classifier</p>
                        <p><strong>Features:</strong> 15 technical & sentiment indicators</p>
                        <p><strong>Training Data:</strong> Historical Bitcoin prices + Wikipedia sentiment</p>
                        <p><strong>Update Frequency:</strong> Daily automatic retraining</p>
                        <p><strong>Prediction Target:</strong> Next-day price direction (UP/DOWN)</p>
                        
                        <!-- Confidence Stats -->
                        <div id="confidenceStats" class="confidence-stats">
                            <strong>Confidence Distribution:</strong><br>
                            Loading...
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- History Tab -->
            <div id="history" class="tab-content">
                <div class="chart-container">
                    <h2 class="chart-title"><i class="fas fa-history"></i> Recent Predictions</h2>
                    <div class="history-list" id="historyList">
                        <!-- History items will be added here dynamically -->
                    </div>
                    
                    <!-- History Metadata -->
                    <div id="historyMetadata" class="history-metadata">
                        <p>Loading history metadata...</p>
                    </div>
                </div>
                
                <div class="info-grid">
                    <div class="info-item">
                        <h3><i class="fas fa-trophy"></i> Performance Summary</h3>
                        <div id="performanceSummary">
                            <p>Loading performance data...</p>
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <h3><i class="fas fa-calendar-alt"></i> Prediction Calendar</h3>
                        <div id="predictionCalendar">
                            <p>Last 7 days of predictions:</p>
                            <div class="calendar-grid" id="calendarGrid">
                                <!-- Calendar items will be added here -->
                            </div>
                        </div>
                        
                        <!-- Export Button -->
                        <div class="export-section">
                            <button class="button button-secondary" onclick="exportPredictionData()">
                                <i class="fas fa-download"></i> Export Prediction Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            
            <!-- Add this after the History tab content -->
            <div id="training" class="tab-content">
                <div class="training-section">
                    <h2 class="chart-title"><i class="fas fa-cogs"></i> Model Training</h2>
                    <p>Run manual model training to update Wikipedia data and retrain the prediction model.</p>
                    
                    <div class="training-controls">
                        <button class="button" onclick="startTraining()" id="trainBtn">
                            <i class="fas fa-play"></i> Start Training
                        </button>
                        <button class="button button-secondary" onclick="clearTrainingLog()">
                            <i class="fas fa-trash"></i> Clear Log
                        </button>
                    </div>

                    <!-- Training Status -->
                    <div class="training-status" id="trainingStatus">
                        <div class="status-indicator">
                            <span class="status-dot idle"></span>
                            <span id="statusText">Ready to train</span>
                        </div>
                        <div class="training-metrics" id="trainingMetrics">
                            <!-- Metrics will be populated dynamically -->
                        </div>
                    </div>

                    <!-- Real-time Training Log -->
                    <div class="training-log-container">
                        <h3><i class="fas fa-terminal"></i> Training Log</h3>
                        <div class="training-log" id="trainingLog">
                            <div class="log-entry info">
                                <span class="timestamp">[System]</span>
                                <span class="message">Training log ready. Click "Start Training" to begin.</span>
                            </div>
                        </div>
                    </div>

                    <!-- Training Results Summary -->
                    <div class="training-results" id="trainingResults" style="display: none;">
                        <h3><i class="fas fa-chart-line"></i> Training Results</h3>
                        <div class="results-grid">
                            <div class="result-card">
                                <div class="result-label">Duration</div>
                                <div class="result-value" id="resultDuration">--</div>
                            </div>
                            <div class="result-card">
                                <div class="result-label">Features</div>
                                <div class="result-value" id="resultFeatures">--</div>
                            </div>
                            <div class="result-card">
                                <div class="result-label">Accuracy</div>
                                <div class="result-value" id="resultAccuracy">--</div>
                            </div>
                            <div class="result-card">
                                <div class="result-value" id="resultPrediction">--</div>
                                <div class="result-label">Prediction</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading Indicator -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p id="loadingText">Analyzing data...</p>
                <p id="loadingSubtext">Processing Wikipedia sentiment and technical indicators...</p>
            </div>
            
            <!-- Status Section -->
            <div class="status">
                <strong><i class="fas fa-server"></i> System Status:</strong>
                <div id="statusInfo">Checking...</div>
            </div>
            
            <!-- Debug Section 
            <div class="debug-section">
                <strong><i class="fas fa-bug"></i> Debug Tools:</strong>
                <button class="button debug-btn" onclick="debugSentiment()">
                    Check Sentiment Data
                </button>
                <button class="button debug-btn" onclick="console.log('Price Chart:', priceChart)">
                    Debug Charts
                </button>
            </div>
            -->
            <!-- Disclaimer -->
            <div class="disclaimer">
                <strong><i class="fas fa-exclamation-triangle"></i> Disclaimer:</strong> 
                This is for educational purposes only. Cryptocurrency investments carry high risk. Always do your own research and consult with a qualified financial advisor before making investment decisions.
            </div>
        </div>
    </div>

    <!-- Our JavaScript -->
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>

    <!-- Error Toast Container -->
    <div id="errorToast" class="error-toast"></div>

    <script>
        // Simple fallback if charts still don't load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing charts...');
            
            // Check if Chart.js is loaded
            if (typeof Chart === 'undefined') {
                console.error('Chart.js not loaded!');
                // Try to reload Chart.js
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js';
                document.head.appendChild(script);
                
                script.onload = function() {
                    console.log('Chart.js loaded dynamically');
                    if (typeof initializeCharts === 'function') {
                        initializeCharts();
                    }
                };
            }
            
            // Force chart resize after a short delay to ensure containers are visible
            setTimeout(() => {
                if (typeof priceChart !== 'undefined' && priceChart) {
                    priceChart.resize();
                }
                if (typeof sentimentChart !== 'undefined' && sentimentChart) {
                    sentimentChart.resize();
                }
            }, 1000);
        });

        // Add resize handler for charts
        window.addEventListener('resize', function() {
            if (typeof priceChart !== 'undefined' && priceChart) {
                priceChart.resize();
            }
            if (typeof sentimentChart !== 'undefined' && sentimentChart) {
                sentimentChart.resize();
            }
            if (typeof performanceChart !== 'undefined' && performanceChart) {
                performanceChart.resize();
            }
        });
    </script>
</body>
</html>